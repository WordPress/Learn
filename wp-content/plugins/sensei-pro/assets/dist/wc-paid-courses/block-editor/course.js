(()=>{var e={4184:(e,t)=>{var s;!function(){"use strict";var r={}.hasOwnProperty;function o(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var n=typeof s;if("string"===n||"number"===n)e.push(s);else if(Array.isArray(s)){if(s.length){var c=o.apply(null,s);c&&e.push(c)}}else if("object"===n)if(s.toString===Object.prototype.toString)for(var l in s)r.call(s,l)&&s[l]&&e.push(l);else e.push(s.toString())}}return e.join(" ")}e.exports?(o.default=o,e.exports=o):void 0===(s=function(){return o}.apply(t,[]))||(e.exports=s)}()},4794:(e,t)=>{var s;!function(){"use strict";var r={}.hasOwnProperty;function o(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var n=typeof s;if("string"===n||"number"===n)e.push(s);else if(Array.isArray(s)){if(s.length){var c=o.apply(null,s);c&&e.push(c)}}else if("object"===n)if(s.toString===Object.prototype.toString)for(var l in s)r.call(s,l)&&s[l]&&e.push(l);else e.push(s.toString())}}return e.join(" ")}e.exports?(o.default=o,e.exports=o):void 0===(s=function(){return o}.apply(t,[]))||(e.exports=s)}()}},t={};function s(r){var o=t[r];if(void 0!==o)return o.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,s),n.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";const e=window.wp.element,t=window.wp.plugins,r=window.wp.components,o=window.wp.data,n=window.wp.i18n;function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},c.apply(this,arguments)}const l=window.lodash,i=window.wp.dataControls,a=window.wp.url,d=window.wp.deprecated;var u=s.n(d);const p={setNonMembershipProducts:e=>({type:"DEPRECATED_SET_NORMAL_PRODUCTS",products:e}),setAssignableProducts:function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{type:"SET_ASSIGNABLE_PRODUCTS",ids:e.map((e=>e.id)),entities:(0,l.keyBy)(e,"id"),onTop:t}},setLinkedMembershipProducts:e=>({type:"SET_LINKED_MEMBERSHIP_PRODUCTS",ids:e.map((e=>e.id)),entities:(0,l.keyBy)(e,"id")}),*toggleProduct(e,t){const s=(yield o.controls.select("core/editor","getEditedPostAttribute","meta"))?._course_woocommerce_product;let r;r=t?[...s,e]:s.filter((t=>t!==e)),yield o.controls.dispatch("core/editor","editPost",{meta:{_course_woocommerce_product:r}})},*updateSelectedProducts(e){yield o.controls.dispatch("core/editor","editPost",{meta:{_course_woocommerce_product:e}})},toggleModalProduct:(e,t)=>({type:"TOGGLE_MODAL_PRODUCT",productId:e,add:t}),updateModalSelectedProducts:e=>({type:"UPDATE_MODAL_SELECTED_PRODUCTS",productIds:e}),*createProduct(e){let{name:t,price:s,description:r}=e,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const c=yield(0,i.apiFetch)({path:"/wc/v3/products",method:"POST",data:{name:t,type:"simple",regular_price:s,virtual:!0,downloadable:!0,description:r,short_description:r}});yield p.setAssignableProducts([{id:c.id,name:c.name,description:c.short_description,price_html:c.price_html,linked_courses:[],total_sales:0}],!0),n?yield p.toggleModalProduct(c.id,!0):yield p.toggleProduct(c.id,!0);const l=yield o.controls.select("core/editor","getCurrentPost");window.sensei_log_event("course_product_add",{course_id:l.id,is_modal:n?1:0})}},m={getProducts:e=>{let{normalProducts:t,membershipProducts:s}=e;return u()("getProducts selector",{since:"2.4.0",alternative:"getLinkedProducts and getLinkedMembershipProducts"}),[...t,...s]},getAssignableProducts:(e,t)=>{let{products:{assignableProductIds:s,entities:r}}=e;const o=s.map((e=>r[e]));return t?o.filter((e=>e.name.match(new RegExp(t,"i")))):o},getHasAssignableProducts:e=>{let{products:{assignableProductIds:t}}=e;return t.length>0},getLinkedProducts:(0,o.createRegistrySelector)((e=>t=>{let{products:{entities:s}}=t;return(e("core/editor").getEditedPostAttribute("meta")?._course_woocommerce_product||[]).map((e=>s?.[e])).filter((e=>e))})),getToggledProductsWithSales:(0,o.createRegistrySelector)((e=>t=>{let{products:{entities:s}}=t;const r=e("core/editor").getCurrentPostAttribute("meta")?._course_woocommerce_product||[],o=e("core/editor").getEditedPostAttribute("meta")?._course_woocommerce_product||[],n=(e,t)=>(0,l.difference)(e,t).map((e=>s?.[e])).filter((e=>e.total_sales>0));return{added:n(o,r),removed:n(r,o)}})),getModalSelectedProductIds:e=>{let{products:{modalSelectedProductIds:t}}=e;return t},getLinkedMembershipProducts:e=>{let{products:{linkedMembershipProductIds:t,entities:s}}=e;return t.map((e=>s?.[e])).filter((e=>e))},getProductById:(e,t)=>{let{products:{entities:s}}=e;return s[t]}},_={*getProducts(){const e=yield o.controls.select("core/editor","getCurrentPost"),t=e.course_membership_products?e.course_membership_products:[],s=[...e.meta?._course_woocommerce_product?e.meta._course_woocommerce_product:[],...t];if(0===s.length)return;let r={};try{r=yield(0,i.apiFetch)({path:`/sensei-wcpc-internal/v1/course-products?include=${s.join(",")}`})}catch(e){const t=(0,n.sprintf)(
/* translators: Error message. */
(0,n.__)("An error was encountered while fetching products: %s","sensei-pro"),e.message);return void(yield o.controls.dispatch("core/notices","createErrorNotice",t,{id:"sensei-products-fetch-error"}))}if(r?.products.length){const e=(0,l.uniq)(s).map((e=>(0,l.find)(r.products,{id:e}))).filter((e=>e)),o=(0,l.remove)(e,(e=>t.includes(e.id)));return yield{type:"DEPRECATED_SET_MEMBERSHIP_PRODUCTS",products:o},p.setNonMembershipProducts(e)}},*getAssignableProducts(e){try{const t=yield o.controls.select("core/editor","getCurrentPost"),s=(0,a.addQueryArgs)("/sensei-wcpc-internal/v1/course-products",{course_id:t.id,per_page:-1,catalog_visibility:"visible",search:e||void 0,linked_first:!e||void 0}),r=(yield(0,i.apiFetch)({path:s}))?.products||[];yield p.setAssignableProducts(r)}catch(e){const t=(0,n.sprintf)(
/* translators: Error message. */
(0,n.__)("An error was encountered while fetching assignable products: %s","sensei-pro"),e.message);yield o.controls.dispatch("core/notices","createErrorNotice",t,{id:"sensei-assignable-products-fetch-error"})}},*getLinkedProducts(){yield o.controls.select(g,"getAssignableProducts","")},*getLinkedMembershipProducts(){try{const e=yield o.controls.select("core/editor","getCurrentPost"),t=e.course_membership_products?e.course_membership_products:[];if(t.length>0){const e=(yield(0,i.apiFetch)({path:`/sensei-wcpc-internal/v1/course-products?include=${t.join(",")}`}))?.products||[];return p.setLinkedMembershipProducts(e)}}catch(e){const t=(0,n.sprintf)(
/* translators: Error message. */
(0,n.__)("An error was encountered while fetching membership products: %s","sensei-pro"),e.message);yield o.controls.dispatch("core/notices","createErrorNotice",t,{id:"sensei-membership-products-fetch-error"})}}},g="sensei-wc-paid-courses/products";(0,o.registerStore)(g,{reducer:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{normalProducts:[],membershipProducts:[],products:{assignableProductIds:[],linkedMembershipProductIds:[],modalSelectedProductIds:[],entities:{}}},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"DEPRECATED_SET_NORMAL_PRODUCTS":const s=t.products.filter((t=>{let{id:s}=t;return void 0===(0,l.find)(e.membershipProducts,{id:s})}));return 0===(0,l.xorBy)(e.normalProducts,s,"id").length?e:{...e,normalProducts:s};case"DEPRECATED_SET_MEMBERSHIP_PRODUCTS":const r=e.normalProducts.filter((e=>{let{id:s}=e;return void 0===(0,l.find)(t.products,{id:s})}));return{...e,membershipProducts:[...t.products],normalProducts:r};case"SET_ASSIGNABLE_PRODUCTS":const o=(0,l.uniq)(t.onTop?[...t.ids,...e.products.assignableProductIds]:[...e.products.assignableProductIds,...t.ids]);return{...e,products:{...e.products,assignableProductIds:o,entities:{...e.products.entities,...t.entities}}};case"SET_LINKED_MEMBERSHIP_PRODUCTS":return{...e,products:{...e.products,linkedMembershipProductIds:(0,l.uniq)([...e.products.linkedMembershipProductIds,...t.ids]),entities:{...e.products.entities,...t.entities}}};case"TOGGLE_MODAL_PRODUCT":const n=t.add?[...e.products.modalSelectedProductIds,t.productId]:e.products.modalSelectedProductIds.filter((e=>e!==t.productId));return{...e,products:{...e.products,modalSelectedProductIds:n}};case"UPDATE_MODAL_SELECTED_PRODUCTS":return{...e,products:{...e.products,modalSelectedProductIds:t.productIds}};default:return e}},actions:p,selectors:m,resolvers:_,controls:i.controls}),(()=>{const e=(0,o.select)("core/editor");let t;(e=>{let{subscribeListener:t=(()=>{}),onSetDirty:s=(()=>{}),onSaveStart:r=(()=>{}),onSave:n=(()=>{})}=e;const c=(0,o.select)("core/editor");let l=!1,i=!1;(0,o.subscribe)((()=>{t();const e=c.isEditedPostDirty(),o=c.isSavingPost()&&!c.isAutosavingPost();!i&&e?(i=!0,s()):i=e,l&&!o?(l=o,n()):!l&&o?(l=o,r()):l=o}))})({onSaveStart:()=>{t=e.getCurrentPostAttribute("meta")?._course_woocommerce_product||[]},onSave:()=>{const s=e.getCurrentPostAttribute("meta")?._course_woocommerce_product||[],r=e.getCurrentPost();t!==s&&window.sensei_log_event("course_product_update",{course_id:r.id,course_status:r.status,product_count:s.length})}})})();const h=window.senseiWcPaidCoursesBlockEditorData.wc_currency_symbol,E=function(){let{fieldsetClassName:t,fieldClassName:s,modalScope:l=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{createProduct:i}=(0,o.useDispatch)(g),[a,d]=(0,e.useState)({}),[u,p]=(0,e.useState)(!1),[m,_]=(0,e.useState)(null),E=e=>({value:a[e]||"",onChange:t=>d((s=>({...s,[e]:t})))});return{fieldset:(0,e.createElement)("fieldset",{className:t},m&&(0,e.createElement)(r.Notice,{className:"sensei-wcpc-new-product__error",status:"error",isDismissible:!1},(0,e.createElement)(e.RawHTML,null,m)),(0,e.createElement)(r.TextControl,c({className:s,label:(0,n.__)("Name","sensei-pro"),required:!0},E("name"))),(0,e.createElement)(r.TextControl,c({className:s,label:(0,e.createElement)(e.Fragment,null,(0,n.__)("Price","sensei-pro"),h&&(0,e.createElement)(e.RawHTML,{style:{display:"inline"}},` (${h})`)),type:"number",required:!0},E("price"))),(0,e.createElement)(r.TextareaControl,c({className:s,label:(0,n.__)("Description (Optional)","sensei-pro")},E("description")))),formState:a,isSubmitting:u,saveProduct:async()=>{let e=!1;p(!0);try{await i(a,l),d({}),_(null),e=!0}catch(e){_((0,n.sprintf)(
/* translators: Error message. */
(0,n.__)("An error was encountered while creating the product: %s","sensei-pro"),e.message))}return p(!1),e}}},w=t=>{let{showCreateButton:s,isFormActive:o,setFormActive:c}=t;const{fieldset:l,isSubmitting:i,saveProduct:a}=E({fieldsetClassName:"sensei-wcpc-course-pricing__new-product-fieldset"});return o?(0,e.createElement)("form",{onSubmit:async e=>{e.preventDefault(),await a()&&c(!1)}},l,(0,e.createElement)("ul",{className:"sensei-wcpc-new-product__action-buttons"},(0,e.createElement)("li",null,(0,e.createElement)(r.Button,{className:"sensei-wcpc-new-product__create-product-button",isSecondary:!0,type:"submit",disabled:i},(0,n.__)("Create product","sensei-pro"),i&&(0,e.createElement)(r.Spinner,null))),(0,e.createElement)("li",null,(0,e.createElement)(r.Button,{isTertiary:!0,disabled:i,onClick:()=>c(!1)},(0,n.__)("Cancel","sensei-pro"))))):s?(0,e.createElement)(r.Button,{isTertiary:!0,onClick:()=>c(!0)},(0,n.__)("Create a new product","sensei-pro")):null},b=window.wp.primitives,P=(0,e.createElement)(b.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},(0,e.createElement)(b.Path,{d:"M12 13.06l3.712 3.713 1.061-1.06L13.061 12l3.712-3.712-1.06-1.06L12 10.938 8.288 7.227l-1.061 1.06L10.939 12l-3.712 3.712 1.06 1.061L12 13.061z"})),y=t=>{let{toggleProduct:s}=t;const{products:c}=(0,o.useSelect)((e=>({products:e(g).getLinkedProducts()})));return(0,e.createElement)("ul",{className:"sensei-wcpc-course-pricing__selected-list"},c.map((t=>(0,e.createElement)("li",{key:t.id,className:"sensei-wcpc-course-pricing__selected-list__item"},(0,e.createElement)("span",{className:"sensei-wcpc-course-pricing__selected-list__product-text"},t.name,t.price_html&&(0,e.createElement)(e.RawHTML,{className:"sensei-wcpc-course-pricing__selected-list__price"}," — "+t.price_html)),(0,e.createElement)(r.Button,{className:"sensei-wcpc-course-pricing__selected-list__remove-button",onClick:()=>s(t.id,!1),icon:P,label:(0,n.__)("Remove product","sensei-pro")})))))};var S=s(4184),v=s.n(S);const f=t=>{let{className:s,contentLabel:o,title:c,intro:l,actions:i,formProps:a,onClose:d,children:u}=t;const p=a?"form":e.Fragment;return(0,e.createElement)(r.Modal,{className:v()(s,"sensei-wcpc-modal"),onRequestClose:d,contentLabel:o},(0,e.createElement)("header",{className:"sensei-wcpc-modal__header"},(0,e.createElement)("h1",{className:"sensei-wcpc-modal__title"},c),l&&(0,e.createElement)("p",{className:"sensei-wcpc-modal__intro"},l)),(0,e.createElement)(r.Button,{className:"sensei-wcpc-modal__close-button",onClick:d,icon:P,label:(0,n.__)("Close modal","sensei-pro")}),(0,e.createElement)(p,a||{},u,i&&(0,e.createElement)("ul",{className:"sensei-wcpc-modal__buttons-list"},i.map((t=>{let{id:s,label:o,inverted:n,buttonProps:c}=t;return(0,e.createElement)("li",{key:s,className:v()({"sensei-wcpc-modal__buttons-list__text-item":!c,"sensei-wcpc-modal__buttons-list__inverted-position-item":n})},c?(0,e.createElement)(r.Button,c,o):o)})))))},C=t=>{let{onBack:s,onClose:c}=t;const{toggledProductsWithSales:l}=(0,o.useSelect)((e=>({toggledProductsWithSales:e(g).getToggledProductsWithSales()}))),{toggleProduct:i}=(0,o.useDispatch)(g),a=l.added.length,d=l.removed.length;(0,e.useEffect)((()=>{0===a&&0===d&&c()}),[a,d]);const u=(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,(0,n.__)("Product","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Price","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Linked courses","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Purchases","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Action","sensei-pro")))),p=(t,s)=>o=>(0,e.createElement)("tr",{key:o.id},(0,e.createElement)("td",{className:"sensei-wcpc-enrollment-updates-modal__table__product-name"},o.name),(0,e.createElement)("td",null,(0,e.createElement)(e.RawHTML,null,o.price_html)),(0,e.createElement)("td",null,0===o.linked_courses.length?(0,n.__)("No linked courses","sensei-pro"):(0,n.sprintf)(// translators: placeholder is number of linked courses.
(0,n._n)("%d linked course","%d linked courses",o.linked_courses.length,"sensei-pro"),o.linked_courses.length)),(0,e.createElement)("td",null,(0,n.sprintf)(// translators: placeholder is the total sales.
(0,n._n)("%d purchase","%d purchases",o.total_sales,"sensei-pro"),o.total_sales)),(0,e.createElement)("td",{className:"sensei-wcpc-enrollment-updates-modal__table__action"},(0,e.createElement)(r.Button,{isTertiary:!0,onClick:()=>s(o)},t))),m=[{id:"proceed",label:(0,n.__)("Proceed with updates","sensei-pro"),buttonProps:{isPrimary:!0,onClick:c}}];return s&&m.unshift({id:"back",label:(0,n.__)("< Back","sensei-pro"),inverted:!0,buttonProps:{isSecondary:!0,onClick:s}}),(0,e.createElement)(f,{contentLabel:(0,n.__)("Enrollment updates","sensei-pro"),title:(0,n.__)("Are you sure you want to make these enrollment updates?","sensei-pro"),actions:m,onClose:c},a>0&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("p",null,(0,n._n)("Linking this product may enroll all learners who have already purchased it.","Linking these products may enroll all learners who have already purchased any of them.",a,"sensei-pro")),(0,e.createElement)("table",{className:"sensei-wcpc-enrollment-updates-modal__table"},u,(0,e.createElement)("tbody",null,l.added.map(p((0,n.__)("Remove product","sensei-pro"),(e=>{i(e.id,!1)})))))),d>0&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("p",null,(0,n._n)("Unlinking this product may unenroll all the learners who have already purchased it.","Unlinking these products may unenroll all the learners who have already purchased any of them.",d,"sensei-pro")),(0,e.createElement)("table",{className:"sensei-wcpc-enrollment-updates-modal__table"},u,(0,e.createElement)("tbody",null,l.removed.map(p((0,n.__)("Add product","sensei-pro"),(e=>{i(e.id,!0)})))))))},k=()=>{const[t,s]=(0,e.useState)(!1),[c,l]=(0,e.useState)(!1),{toggledProductsWithSales:i}=(0,o.useSelect)((e=>({toggledProductsWithSales:e(g).getToggledProductsWithSales()}))),a=i.added.length,d=i.removed.length;return(0,e.createElement)(e.Fragment,null,!t&&(a>0||d>0)&&(0,e.createElement)(r.Notice,{className:"sensei-wcpc-course-pricing__notice",status:"warning",isDismissible:!0,onRemove:()=>s(!0),actions:[{label:(0,n.__)("Review","sensei-pro"),onClick:()=>l(!0)}]},(0,e.createElement)("p",null,(0,n.__)("You have some enrollment updates","sensei-pro"))),c&&(0,e.createElement)(C,{onClose:()=>l(!1)}))},N=()=>{const[t,s]=(0,e.useState)(""),r=(0,e.useCallback)((0,l.debounce)((e=>{s(e)}),250),[]),{products:n,isLoadingProducts:c,hasAssignableProducts:i}=(0,o.useSelect)((e=>{const s=e(g);return{products:s.getAssignableProducts(t),isLoadingProducts:!s.hasFinishedResolution("getAssignableProducts",[t]),hasAssignableProducts:s.getHasAssignableProducts()}}),[t]);return{products:n,isLoadingProducts:c,hasAssignableProducts:i,onSearch:r}},T=()=>{const{products:t,isLoadingProducts:s,hasAssignableProducts:c,onSearch:l}=N(),{selectedProductIds:i}=(0,o.useSelect)((e=>({selectedProductIds:e("core/editor").getEditedPostAttribute("meta")?._course_woocommerce_product}))),{courseId:a}=(0,o.useSelect)((e=>({courseId:e("core/editor").getCurrentPost()?.id}))),{toggleProduct:d}=(0,o.useDispatch)(g),[u,p]=(0,e.useState)(!1);let m;return m=s||!i?(0,e.createElement)("div",{className:"sensei-wcpc-course-pricing__loading"},(0,e.createElement)(r.Spinner,null)):c?0===t.length?(0,n.__)("No products found.","sensei-pro"):(0,e.createElement)("ul",{className:"sensei-wcpc-course-pricing__selection-list"},t.map((t=>(0,e.createElement)("li",{key:t.id,className:"sensei-wcpc-course-pricing__selection-list__item"},(0,e.createElement)(r.CheckboxControl,{label:(0,e.createElement)(e.Fragment,null,(0,e.createElement)("span",{className:"sensei-wcpc-course-pricing__selection-list__item__name"},t.name),(0,e.createElement)("span",{className:"sensei-wcpc-course-pricing__selection-list__item__details"},t.price_html&&(0,e.createElement)(e.RawHTML,{className:"sensei-wcpc-course-pricing__selection-list__item__price"},t.price_html),(0,e.createElement)("span",null,0===t.linked_courses.length?(0,n.__)("No linked courses","sensei-pro"):(0,n.sprintf)(// translators: placeholder is number of linked courses.
(0,n._n)("%d linked course","%d linked courses",t.linked_courses.length,"sensei-pro"),t.linked_courses.length)))),checked:i.includes(t.id),onChange:e=>{d(t.id,e),window.sensei_log_event("course_pricing_product_select",{course_id:a,product_id:t.id,enabled:e?1:0})}}))))):!u&&(0,e.createElement)("div",null,(0,e.createElement)("p",null,(0,n.__)("You don’t have any products yet. Get started by creating a new WooCommerce product.","sensei-pro")),(0,e.createElement)(r.Button,{isSecondary:!0,isSmall:!0,onClick:()=>p(!0)},(0,n.__)("Create a product","sensei-pro"))),(0,e.createElement)(r.PanelBody,{title:(0,n.__)("Pricing","sensei-pro"),className:"sensei-wcpc-course-pricing"},(0,e.createElement)("p",null,(0,n.__)("To access this course, learners will need to purchase one of the assigned products.","sensei-pro")),(0,e.createElement)(y,{toggleProduct:d}),(0,e.createElement)(k,null),c&&(0,e.createElement)(r.TextControl,{type:"search",label:(0,n.__)("Link one or more products to this course to set the price.","sensei-pro"),placeholder:(0,n.__)("Search for a product","sensei-pro"),onChange:l}),m&&(0,e.createElement)("div",{className:"sensei-wcpc-course-pricing__selection-list-wrapper"},m),(0,e.createElement)(w,{showCreateButton:c,isFormActive:u,setFormActive:p}))};(0,t.registerPlugin)("sensei-wc-paid-courses-pricing-sidebar-plugin",{render:()=>(0,e.createElement)(r.Fill,{name:"SenseiCourseSidebar"},(0,e.createElement)(T,null)),icon:null});const A=window.wp.hooks,L=window.wp.compose,M=window.wp.blockEditor,I=t=>{let{products:s,onChange:r,selectedProductId:o}=t;return(0,e.createElement)("div",{className:"wp-block-sensei-lms-purchase-course__products"},(0,e.createElement)("form",null,(0,e.createElement)("ul",{className:"wp-block-sensei-lms-purchase-course__products__list"},s.map((t=>(0,e.createElement)("li",{key:t.id,className:"wp-block-sensei-lms-purchase-course__products__item"},(0,e.createElement)("label",null,(0,e.createElement)("input",{className:"wp-block-sensei-lms-purchase-course__products__radio",name:"wcpc-radio-product",type:"radio",onChange:()=>r(t.id),checked:t.id===o}),(0,e.createElement)("span",{className:"wp-block-sensei-lms-purchase-course__products__label"},(0,e.createElement)("strong",{className:"wp-block-sensei-lms-purchase-course__products__product-title"},t.name),(0,e.createElement)("span",{className:"wp-block-sensei-lms-purchase-course__products__product-description"},(0,e.createElement)(e.RawHTML,null,t.description)),(0,e.createElement)("span",{className:"wp-block-sensei-lms-purchase-course__products__price"},(0,e.createElement)(e.RawHTML,null,t.price_html))))))))))},D=t=>{const{products:s,EditTakeCourse:r}=t,[o,i]=(0,e.useState)(null);let a=null;o&&(a=(0,l.find)(s,{id:o})),1!==s.length&&a||(a=s[0]);let d=(0,n.__)("Buy","sensei-pro");return a&&(d=`${d} - ${a.price_html}`),(0,e.createElement)(e.Fragment,null,s.length>1&&(0,e.createElement)(I,{products:s,onChange:i,selectedProductId:a.id}),(0,e.createElement)(r,c({},t,{text:(0,e.createElement)(e.RawHTML,null,d)})))};function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},R.apply(this,arguments)}var O=s(4794),B=s.n(O);const x=(0,e.createElement)(b.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},(0,e.createElement)(b.Path,{d:"M18.3 5.6L9.9 16.9l-4.6-3.4-.9 1.2 5.8 4.3 9.3-12.6z"})),F=t=>{let{options:s,optionsLabel:o,icon:n,value:c,onChange:l,toggleProps:i,getMenuItemProps:a,popoverProps:d,...u}=t;const p=s.find((e=>c===e.value));return(0,e.createElement)(r.Dropdown,R({className:"sensei-toolbar-dropdown",popoverProps:{isAlternate:!0,position:"bottom right left",focusOnMount:!0,...d,className:B()(d?.className,"sensei-toolbar-dropdown__popover")},renderToggle:t=>{let{isOpen:s,onToggle:o}=t;return(0,e.createElement)(r.Button,R({onClick:o,icon:n,"aria-expanded":s,"aria-haspopup":"true"},i,{children:i?.children?i.children(p):p?.label}))},renderContent:t=>{let{onClose:n}=t;return(0,e.createElement)(r.NavigableMenu,{role:"menu",stopNavigationEvents:!0},(0,e.createElement)(r.MenuGroup,{label:o},s.map((t=>{const s=t.value===p?.value,o=a?.(t);return(0,e.createElement)(r.MenuItem,R({key:t.value,role:"menuitemradio",isSelected:s,icon:s?x:null,className:B()("sensei-toolbar-dropdown__option",{"is-selected":s},o?.className),onClick:()=>{l(t.value),n()},children:t.label},o))}))))}},u))},U=(0,e.createElement)(b.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},(0,e.createElement)(b.Path,{d:"M13.5 6C10.5 6 8 8.5 8 11.5c0 1.1.3 2.1.9 3l-3.4 3 1 1.1 3.4-2.9c1 .9 2.2 1.4 3.6 1.4 3 0 5.5-2.5 5.5-5.5C19 8.5 16.5 6 13.5 6zm0 9.5c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"})),j=t=>{let{onClose:s,onCancel:o,onSubmit:c}=t;const{fieldset:l,isSubmitting:i,saveProduct:a}=E({fieldsetClassName:"sensei-wcpc-new-product-modal__fieldset",fieldClassName:"sensei-wcpc-new-product-modal__field",modalScope:!0}),d=[{id:"cancel",label:(0,n.__)("Cancel","sensei-pro"),buttonProps:{isSecondary:!0,type:"button",onClick:o,disabled:i}},{id:"create-product",label:(0,e.createElement)(e.Fragment,null,(0,n.__)("Create product","sensei-pro"),i&&(0,e.createElement)(r.Spinner,null)),buttonProps:{className:"sensei-wcpc-new-product__create-product-button",isPrimary:!0,type:"submit",disabled:i}}];return(0,e.createElement)(f,{className:"sensei-wcpc-new-product-modal",contentLabel:(0,n.__)("Product creation","sensei-pro"),title:(0,n.__)("Create a new product","sensei-pro"),actions:d,formProps:{onSubmit:async e=>{e.preventDefault(),await a()&&c()}},onClose:s},l)},H=t=>{let{initialSelectedProductIds:s,onSubmit:c,onClose:l}=t;const{selectedProductIds:i,toggleProduct:a,submitSelection:d}=(t=>{const{selectedProductIds:s}=(0,o.useSelect)((e=>({selectedProductIds:e(g).getModalSelectedProductIds()}))),{updateSelectedProducts:r,updateModalSelectedProducts:n,toggleModalProduct:c}=(0,o.useDispatch)(g);return(0,e.useEffect)((()=>{n(t)}),[t]),{selectedProductIds:s,toggleProduct:c,submitSelection:async()=>{await r(s)}}})(s),{products:u,isLoadingProducts:p,hasAssignableProducts:m,onSearch:_}=N(),[h,E]=(0,e.useState)(!1);if(h)return(0,e.createElement)(j,{onClose:l,onCancel:()=>E(!1),onSubmit:()=>E(!1)});let w;w=p?(0,e.createElement)("div",{className:"sensei-wcpc-product-association-modal__loading"},(0,e.createElement)(r.Spinner,null)):m?0===u.length?(0,e.createElement)("p",null,(0,n.__)("No products found.","sensei-pro")):(0,e.createElement)("table",{className:"sensei-wcpc-product-association-modal__products-table"},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,(0,n.__)("Select the product","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Product","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Price","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Linked courses","sensei-pro")),(0,e.createElement)("th",null,(0,n.__)("Purchases","sensei-pro")))),(0,e.createElement)("tbody",null,u.map((t=>(0,e.createElement)("tr",{key:t.id},(0,e.createElement)("td",{className:"sensei-wcpc-product-association-modal__products-table__checkbox-column"},(0,e.createElement)(r.CheckboxControl,{id:`product-selection-${t.id}`,checked:i.includes(t.id),onChange:e=>a(t.id,e)})),(0,e.createElement)("td",null,(0,e.createElement)("label",{className:"sensei-wcpc-product-association-modal__products-table__product-name",htmlFor:`product-selection-${t.id}`},t.name)),(0,e.createElement)("td",null,(0,e.createElement)(e.RawHTML,null,t.price_html)),(0,e.createElement)("td",null,0===t.linked_courses.length?(0,n.__)("No linked courses","sensei-pro"):(0,n.sprintf)(// translators: placeholder is number of linked courses.
(0,n._n)("%d linked course","%d linked courses",t.linked_courses.length,"sensei-pro"),t.linked_courses.length)),(0,e.createElement)("td",null,t.total_sales>0?(0,e.createElement)(r.Tooltip,{text:(0,n.__)("Toggling this product may affect existing enrollments.","sensei-pro")},(0,e.createElement)("span",null,(0,n.__)("Has purchases","sensei-pro"))):(0,n.__)("No purchases","sensei-pro"))))))):(0,e.createElement)("div",null,(0,e.createElement)("p",null,(0,n.__)("You don’t have any products yet. Get started by creating a new WooCommerce product.","sensei-pro")),(0,e.createElement)(r.Button,{isSecondary:!0,isSmall:!0,onClick:()=>E(!0)},(0,n.__)("Create a product","sensei-pro")));const b=[{id:"selected",label:(0,n.sprintf)(// translators: placeholder is number of selected products.
(0,n._n)("%d product selected","%d products selected",i.length,"sensei-pro"),i.length)},{id:"button",label:0===s.length?(0,n.__)("Link products","sensei-pro"):(0,n.__)("Update","sensei-pro"),buttonProps:{isPrimary:!0,onClick:async()=>{await d(),c(i),l()}}}];return(0,e.createElement)(f,{className:"sensei-wcpc-product-association-modal",contentLabel:(0,n.__)("Course products association","sensei-pro"),title:(0,n.__)("Add pricing by linking one or more products to this course","sensei-pro"),intro:(0,n.__)("To access this course, learners will need to purchase one of the assigned products.","sensei-pro"),actions:b,onClose:l},(0,e.createElement)("div",{className:"sensei-wcpc-product-association-modal__actions"},(0,e.createElement)("div",{className:"sensei-wcpc-product-association-modal__search"},(0,e.createElement)("input",{className:"sensei-wcpc-product-association-modal__search__input",type:"search",title:(0,n.__)("Search for a product","sensei-pro"),placeholder:(0,n.__)("Search for a product","sensei-pro"),onChange:e=>_(e.target.value)}),(0,e.createElement)("span",{className:"sensei-wcpc-product-association-modal__search__icon"},(0,e.createElement)(r.Icon,{icon:U}))),(0,e.createElement)(r.Button,{isTertiary:!0,onClick:()=>E(!0)},(0,n.__)("Create a new product","sensei-pro"))),(0,e.createElement)("div",{className:"sensei-wcpc-product-association-modal__products"},w))},G=t=>{let{hasMemberships:s}=t;const{updateSelectedProducts:r}=(0,o.useDispatch)(g),{metaSelectedProductIds:c}=(0,o.useSelect)((e=>({metaSelectedProductIds:e("core/editor").getEditedPostAttribute("meta")._course_woocommerce_product}))),{courseId:l}=(0,o.useSelect)((e=>({courseId:e("core/editor").getCurrentPost()?.id}))),[i,a]=(0,e.useState)(!1),[d,u]=(0,e.useState)(!1),p=[{label:s?(0,n.__)("Membership only","sensei-pro"):(0,n.__)("Free","sensei-pro"),value:"free"},{label:(0,n.__)("Paid","sensei-pro"),value:"paid"}];return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(F,{options:p,optionsLabel:(0,n.__)("Course pricing","sensei-pro"),value:c.length>0?"paid":"free",onChange:async e=>{"free"===e?(await r([]),u("free")):a(!0),window.sensei_log_event("course_signup_block_pricing_select",{course_id:l,type:e})}}),i&&(0,e.createElement)(H,{initialSelectedProductIds:c,onSubmit:e=>{u("modal"),window.sensei_log_event("course_signup_block_pricing_modal_submit",{course_id:l,product_count:e.length})},onClose:()=>a(!1)}),d&&(0,e.createElement)(C,{onBack:"modal"===d?()=>{u(!1),a(!0)}:void 0,onClose:()=>u(!1)}))},W=t=>s=>{const{products:n,membershipProducts:i}=(0,o.useSelect)((e=>({products:e(g).getLinkedProducts(),membershipProducts:e(g).getLinkedMembershipProducts()}))),a=(0,o.useSelect)((e=>e(g).hasFinishedResolution("getAssignableProducts",[""])&&e(g).hasFinishedResolution("getLinkedMembershipProducts")));if(s.attributes.isPreview)return(0,e.createElement)(t,s);if(!a)return(0,e.createElement)("div",{className:"wp-block-sensei-lms-purchase-course__centered-spinner"},(0,e.createElement)(r.Spinner,null));const d=(0,l.uniqBy)([...n,...i],"id");return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(M.BlockControls,null,(0,e.createElement)(r.ToolbarGroup,null,(0,e.createElement)(G,{hasMemberships:i.length>0}))),d.length?(0,e.createElement)(D,c({products:d,EditTakeCourse:t},s)):(0,e.createElement)(t,s))};(0,A.addFilter)("blocks.registerBlockType","sensei-wc-paid-courses/purchase-course",(e=>"sensei-lms/button-take-course"!==e.name?e:{...e,keywords:[...e.keywords,(0,n.__)("Purchase","sensei-pro"),(0,n.__)("Sell","sensei-pro")],edit:(0,L.compose)(W)(e.edit)}))})()})();
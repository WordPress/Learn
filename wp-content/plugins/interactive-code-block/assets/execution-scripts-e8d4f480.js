import{j as e}from"./jsx-runtime-93b56483.js";import S from"./index-342b93f1.js";import{L as f}from"./index-5648a310.js";import{P as b,S as h,i as d,g as v}from"./index-f75e1766.js";import{i as y}from"./entities-35c9150f.js";import{N as E}from"./notifications-24e351eb.js";import"./preload-helper-41c905a7.js";import"./index-8f2db1d0.js";import"./index-d6204322.js";import"./index-e4a952a6.js";import"./comlink.js";const g={plaintext:"Plain text",html:"HTML",jsontabular:"JSON (tabular)",jsontabularsql:"JSON (tabular, SQL queries)"};function F(){const[t,s]=wp.element.useState(!1),c=()=>s(!0),r=()=>s(!1);return e.jsxs(e.Fragment,{children:[e.jsx(wp.components.Button,{onClick:c,variant:"primary",children:"+ Add Script"}),t&&e.jsx(wp.components.Modal,{onRequestClose:o=>{o.target.closest(".cm-editor")||r()},title:"Create a new script",children:e.jsx(k,{onSaveFinished:()=>{r()}})})]})}function k({onSaveFinished:t}){const{createErrorNotice:s,createSuccessNotice:c}=wp.data.useDispatch(wp.notices.store),[r,o]=wp.element.useState({id:"",name:"",runner:b.id,content:""}),{lastError:a,isSaving:l}=wp.data.useSelect(n=>({lastError:n(wp.coreData.store).getLastEntitySaveError("interactive-code-block","script",void 0),isSaving:n(wp.coreData.store).isSavingEntityRecord("interactive-code-block","script",void 0)}),[]),{saveEntityRecord:m}=wp.data.useDispatch(wp.coreData.store),p=async()=>{try{await m("interactive-code-block","script",r,{throwOnError:!0}),t(),c("Script created successfully",{type:"snackbar"})}catch(n){s(n.message,{type:"snackbar"})}};return e.jsx(x,{script:r,onChange:n=>o({...r,...n}),canSave:!!(r.name&&r.content),onSave:p,lastError:a,isSaving:l})}function R({id:t}){const[s,c]=wp.element.useState(!1),r=()=>c(!0),o=()=>c(!1);return e.jsxs(e.Fragment,{children:[e.jsx(wp.components.Button,{onClick:r,variant:"primary",children:d(t)?"View":"Edit"}),s&&e.jsx(wp.components.Modal,{onRequestClose:o,title:d(t)?"View script":"Edit script",children:e.jsx(D,{id:t,onSaveFinished:o})})]})}function D({id:t,onSaveFinished:s}){const{createErrorNotice:c,createSuccessNotice:r}=wp.data.useDispatch(wp.notices.store),{script:o,lastError:a,isSaving:l,hasEdits:m}=wp.data.useSelect(i=>({script:i(wp.coreData.store).getEditedEntityRecord("interactive-code-block","script",t),lastError:i(wp.coreData.store).getLastEntitySaveError("interactive-code-block","script",t),isSaving:i(wp.coreData.store).isSavingEntityRecord("interactive-code-block","script",t),hasEdits:i(wp.coreData.store).hasEditsForEntityRecord("interactive-code-block","script",t)}),[t]),{saveEditedEntityRecord:p,editEntityRecord:n}=wp.data.useDispatch(wp.coreData.store),u=async()=>{try{await p("interactive-code-block","script",t,{throwOnError:!0}),r("Script saved successfully",{type:"snackbar"}),s()}catch(i){c(i.message,{type:"snackbar"})}},w=i=>n("interactive-code-block","script",t,i);return d(t)?e.jsx(x,{script:v(t),onChange:w,canSave:!1}):e.jsx(x,{script:o,onChange:w,canSave:m,lastError:a,isSaving:l,onSave:u})}function x({script:t,onChange:s,canSave:c,lastError:r,isSaving:o,onSave:a}){const l=wp.element.useMemo(()=>t.content,[]),m=wp.element.useRef(null);function p(n){n.preventDefault(),a?.()}return e.jsxs("form",{className:"interactive-code-block-form",onSubmit:p,children:[r?e.jsxs("div",{className:"form-error",children:["Error: ",r.message]}):!1,e.jsxs(wp.components.Flex,{direction:"column",gap:2,children:[e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.TextControl,{label:"Script name",value:t.name,onChange:n=>s({name:n}),autoFocus:!0})}),e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.SelectControl,{label:"Code Runner",value:t.runner,options:h.map(({id:n})=>({label:n,value:n})),onChange:n=>s({runner:n})})}),e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.SelectControl,{label:"Output format",value:t.outputFormat,options:Object.entries(g).map(([n,u])=>({label:u,value:n})),onChange:n=>s({outputFormat:n})})}),e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.BaseControl,{label:"Script contents",id:"script-contents",children:e.jsx(S,{fileType:"php",initialContents:l,onChange:n=>s({content:n}),onSave:n=>s({content:n}),ref:m},"code-mirror")})}),d(t.id)?!1:e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.BaseControl,{id:t.id,label:"Libraries to load",children:e.jsx(f,{onChange:n=>s({libraries:n}),selected:t.libraries||[]})})}),e.jsx(wp.components.FlexItem,{children:d(t.id)?"This is the default execution script and can't be changed.":e.jsx("div",{className:"interactive-code-block-form__buttons",children:e.jsx(wp.components.Button,{type:"submit",isBusy:o,variant:"primary",disabled:!c||o,children:o?"Saving":"Save"})})})]})]})}function N(){return e.jsxs(wp.components.Flex,{direction:"column",gap:4,children:[e.jsxs(wp.components.FlexItem,{className:"interactive-code-snippet-items-list-wrapper",children:[e.jsxs("p",{children:['When the user clicks "Run" in an interactive code block, they ',e.jsx("b",{children:"don't"})," actually run the code snippet. Instead, they run an ",e.jsx("i",{children:"execution script"})," associated with the code block."]}),e.jsx("p",{children:"The built-in execution scripts are quite simple, but you're free to get more fancy and:"}),e.jsxs("ul",{className:"ul-disc",children:[e.jsx("li",{children:"Load a few libraries"}),e.jsx("li",{children:"Expose some variables to the code snippet"}),e.jsx("li",{children:"Preload an SQLite database"}),e.jsx("li",{children:"Highlight the code snippet instead of executing it"})]})]}),e.jsx(wp.components.FlexItem,{className:"interactive-code-snippet-items-list-wrapper",children:e.jsx(C,{})}),e.jsx(wp.components.FlexItem,{children:e.jsx(F,{})})]})}function C(){const t=wp.coreData.useEntityRecords("interactive-code-block","script");return t.records===null?e.jsx(wp.components.Flex,{align:"center",justify:"center",children:e.jsx(wp.components.FlexItem,{children:e.jsx(wp.components.Spinner,{})})}):!t.records?.length&&!h.length?e.jsx("div",{children:"No results"}):e.jsxs("ul",{className:"interactive-code-snippet-items-list",children:[h.map(s=>e.jsx(j,{id:s.id},s.id)),t.records.map(({id:s})=>e.jsx(j,{id:s},s))]})}const j=({id:t})=>{const{createSuccessNotice:s,createErrorNotice:c}=wp.data.useDispatch(wp.notices.store),r=wp.coreData.useEntityRecord("interactive-code-block","script",t);d(t)&&(r.editedRecord=v(t),r.editedRecord={...r.editedRecord,name:`${r.editedRecord.name} (built-in)`});const{deleteEntityRecord:o}=wp.data.useDispatch("core"),a=async()=>{if(window.confirm(wp.i18n.__("Are you sure you want to delete this script? ALL code blocks using this script will stop working.")))try{await o("interactive-code-block","script",t,null,{throwOnError:!0}),s("The script was deleted!",{type:"snackbar"})}catch(p){const n=(p?.message||"There was an error.")+" Please refresh the page and try again.";c(n,{type:"snackbar"})}},l=wp.components.FlexItem;return e.jsxs(wp.components.Flex,{className:"list-item",children:[e.jsx(l,{isBlock:!0,children:r.editedRecord.name}),e.jsx(wp.components.FlexItem,{children:e.jsx(R,{id:t})}),e.jsx(wp.components.FlexItem,{children:!d(t)&&e.jsx(wp.components.Button,{isDestructive:!0,onClick:a,children:wp.i18n.__("Delete")})})]})};y();window.addEventListener("load",function(){wp.element.render(e.jsxs(e.Fragment,{children:[e.jsx(N,{}),e.jsx(E,{})]}),document.querySelector("#execution-scripts"))},!1);
